# Sindarin

<div align="center">
  <img src="https://tcgplayer-cdn.tcgplayer.com/product/488291_in_1000x1000.jpg" width="400" alt="Sol Ring - Dwarven (0409) - Commander: The Lord of the Rings: Tales of Middle-earth (LTC)">
</div>

A Python library providing binary compatibility with the Nim [enkodo](https://github.com/hortinstein/enkodo) encryption and serialization library.

## Features

- **Binary compatible** with Nim's Flatty serialization format
- **Full encryption/decryption** using pymonocypher
- **All Nim data types** supported: EncObj, EncConfig, StaticConfig, Status, Callback, Task, Resp
- **Config file compatibility** with nim_config generated files
- **Comprehensive test suite** with 26+ tests

## Installation

```bash
pip install pymonocypher
```

## Quick Start

```python
from enkodo import generate_key_pair, encrypt, decrypt

# Generate key pairs
alice_priv, alice_pub = generate_key_pair()
bob_priv, bob_pub = generate_key_pair()

# Encrypt a message from Alice to Bob
message = b"Hello, World!"
enc_obj = encrypt(alice_priv, bob_pub, message)

# Decrypt the message at Bob's end
decrypted = decrypt(bob_priv, enc_obj)
assert decrypted == message
```

## Running Tests

### Prerequisites
Ensure you have pytest installed:
```bash
pip install pytest
```

### Run All Tests
```bash
# Run all tests with verbose output
pytest tests/ -v

# Run specific test categories
pytest tests/test_encryption.py -v          # Encryption functionality
pytest tests/test_serialization.py -v      # Serialization compatibility  
pytest tests/test_config_validation.py -v  # Config file validation
```

### Test Coverage
- **26 tests total**, all passing ✅
- **Encryption tests**: Key generation, encrypt/decrypt roundtrips, error handling
- **Serialization tests**: Binary format compatibility, Nim artifact parsing
- **Config validation**: nim_config file parsing, Python roundtrip validation

### Example Test Output
```bash
$ pytest tests/ -v
========================= test session starts =========================
tests/test_encryption.py::TestKeyGeneration::test_generate_key_pair PASSED
tests/test_encryption.py::TestEncryption::test_encrypt_decrypt_roundtrip PASSED
tests/test_serialization.py::TestBinaryCompatibility::test_flatty_serialization_compatibility PASSED
tests/test_config_validation.py::test_python_to_python_config_roundtrip PASSED
========================= 26 passed in 0.06s =========================
```

## Core Files

- **`flatty.py`** - Nim-compatible Flatty serialization implementation
- **`enkodo.py`** - Encryption library using pymonocypher with all Nim data types  
- **`tests/`** - Comprehensive test suite

## Nim Data Types Supported

All major Nim types from the enkodo library are supported:

- **EncObj**: Encrypted object containing public key, nonce, MAC, and ciphertext
- **EncConfig**: Configuration with private/public keys and encrypted object  
- **StaticConfig**: Build configuration with deployment settings
- **Status**: System status information
- **Callback**: Combined config and status for C2 communication
- **Task**: Task definitions with arguments and responses
- **Resp**: Response objects for task completion

## Config File Compatibility

The library can parse config files generated by nim_config:

```python
import base64
from pathlib import Path

# Read nim_config generated file
config_path = Path("nim_config/debug.config")
with open(config_path, 'r') as f:
    b64_config = f.read().strip()

# Decode and parse EncConfig structure
config_data = base64.urlsafe_b64decode(b64_config)
# Structure: privKey (32) + pubKey (32) + encObj (variable)
```

## Advanced Usage

### Serialization with Flatty
```python
from flatty import to_flatty, b64_encode
from enkodo import StaticConfig

# Create and serialize config
config = StaticConfig(
    build_id="prod_v1.0",
    deployment_id="deploy_001", 
    kill_epoch=1234567890,
    interval=60,
    callback="https://c2.example.com/api"
)

# Serialize to binary format
config_bytes = to_flatty(config)

# Base64 encode for storage/transmission  
b64_config = b64_encode(config_bytes)
```

### Working with EncObj
```python
from enkodo import encrypt, wrap_enc_obj, unwrap_enc_obj

# Encrypt and wrap for transmission
enc_obj = encrypt(sender_priv, recipient_pub, message)
wrapped = wrap_enc_obj(enc_obj)  # Base64 encoded string

# Unwrap and decrypt at destination
enc_obj = unwrap_enc_obj(wrapped)
plaintext = decrypt(recipient_priv, enc_obj)
```

## Documentation

- **[TESTING.md](TESTING.md)** - Detailed testing guide
- **[reports/implementation_report.md](reports/implementation_report.md)** - Technical implementation details

## Status

✅ **Production Ready** - All 26 tests passing with full Nim compatibility

